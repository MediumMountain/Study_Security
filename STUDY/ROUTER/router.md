# ルータ【router】
- コンピュータネットワークの中継・転送機器の一つで、データの転送経路を選択・制御する機能を持ち、複数の異なるネットワーク間の接続・中継に用いられるもの。
- ルータはプロトコル階層のうちネットワーク層（インターネット層、第3層）の情報を解析してデータの転送の可否や転送先の決定などを行う機器で、主にインターネットなどのTCP/IPネットワークにおける主要な中継機器として用いられる。

- 接続先から受信したデータ（パケット）を解析し、IP（Internet Protocol）の制御情報を元に様々な転送制御を行う。
- 中でも最も重要な処理は「ルーティング」（routing）で、パケットの宛先IPアドレスから適切な転送経路を選択し、隣接する機器の中から次に転送すべき相手を決定してパケットを送信する。

- インターネットなど大規模なネットワークでは、ルータ間でこのような転送をバケツリレー式に繰り返し、送信元から宛先へ複数のネットワークを通過してパケットが運ばれていく。

- ルータが経路選択を行う際には一般に、「ルーティングテーブル」（routing table、経路表）と呼ばれるデータ集合が参照される。
- 宛先のネットワーク（のアドレス）ごとにどの機器に中継を依頼すべきかが列挙されており、宛先アドレスに対応する転送先を見つけてその機器にパケットを転送する。


- 静的ルーティングと動的ルーティング
    - 小規模なネットワークでは、ルータのルーティングテーブルを管理者などが固定的に入力・設定する「スタティックルーティング」（static routing：静的ルーティング）が用いられることが多い。
    - 一方、異なる管理主体のネットワーク間の接続や、大規模なネットワーク、頻繁に構成が変更されるネットワークなどでは、ルータ間で定期的に経路情報を交換してルーティングテーブルを作成・更新する「ダイナミックルーティング」（dynamic routing：動的ルーティング）が用いられる。




## ルーティングプロトコル routing protocol
- ルータ間の経路情報の交換に用いられる、専用の通信規約（プロトコル）

- 同一の管理主体の運営するネットワーク（AS：Autonomous System、自律システム）内で用いられるルーティングプロトコルをIGP（Interior Gateway Protocol）と呼び、RIPやOSPF、IGRP、EIGRPなどが用いられる。
- 一方、異なるAS間の接続ではEGP（Exterior Gateway Protocol）と呼ばれるルーティングプロトコルが用いられ、インターネット上では一般にBGPが用いられる。





### AS番号【Autonomous System number】ASN
- インターネットを構成する個々の独立したネットワーク（AS：自律システム）に対して割り当てられている、一意の識別番号。2バイト（16ビット）または4バイト（32ビット）の値で、各国のネットワークインフォメーションセンター（NIC）が発行している。

- インターネットは様々な管理主体の運用する通信ネットワークを相互に接続して成り立っている。
- その構成単位となる、個々の通信事業者やインターネットサービスプロバイダ（ISP）、企業などにより統一された運用方針や制御情報に基づいて通信するネットワークのことをAS（Autonomous System）という。

- インターネット上でのパケットの経路制御はAS間とAS内で分かれており、BGPによるAS間の経路選択を行う際の各ASの識別番号としてAS番号が用いられる。
- 重複を避けるためIANAが統一的に管理しており、各地域の地域インターネットレジストリ（RIR：Regional Internet Registry）にブロック単位で配布され、RIRが各国NICを通じてインターネットへの接続を希望する組織に割り当てを行う。

- AS番号はすべての接続ネットワークに割り当てられるわけではなく、経路制御や選択に必要となる場合に限られる。
- すなわち、複数の異なるASと接続を持ち、パケットが様々な経路に転送されうるAS（マルチホームAS）にはAS番号が与えられるが、単一のAS（上位プロバイダなど）のみを介してインターネットへ接続しており、外部との経路がすべて上位ASを通過するような場合（シングルホームAS）にはAS番号は不要である。

- AS番号は当初は2バイト（16ビット）の値として規定され、0～65535までの整数値として表記された。
- このうち、0と65535は予約されており割り当ては行われない。64512～65534はAS内部で用いる「プライベートAS番号」で、インターネット上では使用しない。

### 4バイトAS番号
- インターネットへの接続ネットワーク数が増え、従来の2バイトの番号では収容しきれなくなってきたため、2007年から4バイト（32ビット）に拡張されたAS番号の割り当てが始まった。
- 割り当て済みの2バイトAS番号は、単純に全ビットの0の上位2バイトを追加することで4バイトAS番号とすることができる（番号としては同じ）。

- 4バイトのAS番号は0～4294967295となり、約42億のASを識別することができる。
- 新たに設けられた65536以上の番号空間のうち、65536～131071と4294967295は予約されている。
- また、4200000000～4294967294はプライベートAS番号用となっている。


## ルータの他機能
- ルータは経路制御だけでなく、アドレス体系の異なるネットワーク間（WANとLAN、プライベートネットワークとインターネットなど）でアドレス変換を行って相互に通信できるようにするNAT/NAPT機能や、ネットワークに新たに接続した機器にDHCPなどで自動的にIPアドレスを割り当てる機能、指定されたルールに従って接続や中継の許可や拒否を行うパケットフィルタリング機能、通信の種類ごとに転送の優先度に差をつけたり、上限の帯域幅を超えないよう制御するQoS制御機能など、様々な機能を持っていることが多い。

- 中継機器
    - プロトコル階層のうちデータリンク層（リンク層、第2層）の情報を元に転送制御を行う機器にはブリッジ（bridge）やネットワークスイッチ（network switch、単にスイッチとも）、スイッチングハブ（switching hub）などがあり、ルータはこれらの機能も内包している。
    - また、転送制御を行わず物理層（第1層）の単純な中継のみを行う機器にはリピータ（repeater）やリピータハブ（repeater hub）などがある。こうした様々な機器をルータと組み合わせてネットワークが構築される。


## NAT
- 二つのIPネットワークの境界にあるルータやゲートウェイが、双方のIPアドレスを対応付けて自動的に変換し、データ伝送を中継する技術。

- 構内ネットワーク（LAN）とインターネットなど、二つのネットワークの間で特定のアドレス同士を対応付け、両者の間を出入りするIPデータグラムに含まれる送信元や宛先のIPアドレスを転送時に自動的に書き換える。

- これにより、両ネットワーク間が直接通信できない場合でも、一方からもう一方へ透過的にアクセスできるようになる。プライベートIPアドレスで運用されているLAN内からインターネット上のサーバへアクセスしたい場合などによく用いられる。


### 送信元NATと宛先NAT
- NATは通信の方向に応じて自動的に送信元あるいは宛先のアドレスを書き換えるが、接続を確立するパケットの扱いによってソースNATとデスティネーションNATに分類される。

- 一般的に用いられるのはLANからインターネットへ送信される接続確立用のパケットの送信元アドレスを書き換える「ソースNAT」（Source NAT/SNAT/送信元NAT）で、LAN内のプライベートIPアドレス（ローカルIPアドレス）しか持たないパソコンなどからインターネットにアクセスするために用いられる。

- 一方、インターネット側からの接続要求の宛先アドレスを自動的にLAN内のアドレスに書き換える方式は「デスティネーションNAT」（Destination NAT/DNAT/宛先NAT）という。
- LAN内にあるサーバなどの機器にインターネット側からアクセスできるようにする手段として用いられ、「バーチャルホスト」「ポートフォワーディング」（ポート転送）とほぼ同義である。


### 静的NATと動的NAT
- IPアドレスの対応付けの仕方によって分類することもある。
- 外部側と内部側のアドレスを一つずつ固定的に対応付け、常に同じアドレスに転送する方式を「静的NAT」（static NAT/スタティックNAT）という。
- 内部から通信したいプライベートアドレスの数だけグローバルアドレスが必要となる。

- 一方、内部から通信要求があるたびにグローバルアドレスを動的に割り当てて当座の通信に用いる方式を「動的NAT」（dynamic NAT/ダイナミックNAT）という。
- 少ないグローバルアドレスで内部の多数の機器が通信できるが、接続ごとに内部側のアドレスが代わるため、宛先NATなどに使うことはできない。


## NAPT(Network Address and Port Translation)
- LANとインターネットなど2つのTCP/IPネットワークの境界にあるルータやゲートウェイが、双方のIPアドレスとポート番号を自動的に変換してデータを中継する技術。
- 内部ネットワークからインターネットへ透過的にアクセスできるようになる。

- 内部ネットワークからインターネットにアクセスする利用者PCについて、インターネットからの不正アクセスを困難にすることができる。

- あるいは「PAT」（Port Address Translation）、「IPマスカレード」（IP masquerade）


- インターネットに接続するにはインターネット上での住所にあたるグローバルIPアドレスが必要だが、企業や家庭などの構内ネットワーク（LAN）では当該ネットワーク内だけで通用するプライベートIPアドレス（ローカルIPアドレス）で運用されている場合があり、プライベートアドレスしか持たない機器はインターネットへ直接アクセスすることはできない。

- NAPTはネットワーク境界上にあるルータなどの中継装置が持つ機能で、プライベートアドレスとグローバルアドレスの相互変換を自動的に行い、ローカル側の機器があたかもインターネットに直接繋がっているかのようにアクセスできるようにする。

- 同種の技術であるNATはIPアドレスのみを変換するため、一つのグローバルアドレスを同時に使えるのは一つのプライベートアドレスのみだが、NAPTではTCPやUDPのポート番号も動的に変換するため、複数のプライベートアドレスが一つのグローバルアドレスを共有して同時にインターネット側と通信することができる。

- ただし、インターネット側の機器からはローカル側の機器がどのポート番号で接続するのか事前に知ることができないため、サーバなどインターネット側から接続を開始する用途には利用できない。
- この制限を緩和するため、利用者があらかじめ指定したIPアドレスとポート番号の組み合わせをインターネット側の特定のポートに固定的に対応付けるといった独自の機能を提供しているブロードバンドルータなどもある。

- 本来、この方式の一般的な名称が「NAPT」、LinuxにおけるNAPTの実装の名前が「IP masquerade」（IPマスカレード）だったが、後者の名称が有名となり、Linux以外でも方式を表す一般名のように用いられる場合がある。
- また、ネットワーク機器の仕様表などに「NAT機能」として紹介されているものは、実際には本来の意味でのNATではなくNAPTであることがほとんどである。