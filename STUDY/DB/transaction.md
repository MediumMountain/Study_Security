# トランザクション

ACID特性は、データベースのトランザクション処理を行う上で必要不可欠とされる4つの性質(Atomicity・Consistency・Isolation・Durability)の頭文字を並べた言葉です。
Atomicity（原子性）
トランザクション内の処理がすべて実行されるか、または全く実行されないことを保証する性質
Consistency（一貫性）
トランザクションによりデータの矛盾が発生せず、常にデータベースの整合性が保たれていることを保証する性質
Isolation（独立性）
隔離性と呼ばれる。複数のトランザクションを同時に実行した場合と、順番に実行した場合の結果が等しくなることを保証する性質
Durability（永続性）
耐久性と呼ばれる。一旦正常終了したトランザクションの結果は、その後システムに障害が発生しても失われないことを保証する性質




undo/redo方式は、データベースにシステム障害が起こったときに、更新前ログを使用したロールバック(undo)と更新後ログを使用したロールフォワード(redo)を組み合わせてデータベースを回復する方法です。undoは行った操作の取り消し、redoは行った操作の再実行という意味です。

障害発生時に進行中だったトランザクションは、一部の更新がディスクに反映されているので、ロールバックを実行してトランザクション開始前の状態に戻します（④）。チェックポイント後にコミットされたトランザクションは、ディスクからコミットの内容が失われているので、ロールフォワードを実行してデータベースにトランザクションの処理結果を反映させます（②③）。

なお、コミットするまでデータベースを一切更新しない遅延更新の管理機構ではロールバックが不要なので、障害回復時にredoのみを行いundoを行わない「no-undo/redo方式」が使われることもあります。

![undo/redo方式](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/undo_redo.png)  




オプティマイザ(optimizer)は、SQL文が実行された際、対象となるレコードの取得時間を最小とするようにアクセスパスを最適化するデータベース管理システム(DBMS)の機能です。レコードを取得するためには、インデックスの使用や表全体の読込みなどの複数の方法が考えられます。オプティマイザはクエリの実行計画を評価し、問合せ内容に応じて最も効率がよい方法を選択します。


コストベースアプローチ
DBMSに蓄積された表やインデックスの統計情報をもとにコストを見積り、その結果に基づいて最も効率的な実行計画を作成する方法
ルールベースアプローチ
複数のアクセスパスが存在する場合に、アクセスパスの優先順位などのような一定のルールに従って実行計画を作成する方法


なお、ルールベースアプローチは、あらかじめ決めておいたアクセスパスの優先順位などのルールに、実行しようとするSQL構文と表やインデックスの定義情報を当てはめて実行計画を作成する方法です。



共用(共有)ロック
データを読込むときに使うロックで、資源がこの状態の場合は他のトランザクションによる更新処理ができなくなる(読込みは可能)。
排他(専有)ロック
データを更新するときに使うロックで、資源がこの状態の場合は他のトランザクションによる読込みや更新ができなくなる。
上記の性質から、ある資源に共用または排他ロックが設定されているときの新たなロックの可否は次の表の通りになります。

![lock](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/lock.png)  


## ２相コミットメント

- トランザクションを他のサイトに更新可能かどうかを確認する第1相と、更新を確定する第2相の2つのフェーズに分け、各サイトのトランザクションをコミットもロールバックも可能な中間状態(セキュア状態)にした後、全サイトがコミットできる場合だけトランザクションをコミットするという方法で分散データベース環境でのトランザクションの原子性・一貫性を保証する手法です。

具体的には、各サイトの更新処理が終わった後に、コミットの調整を行う1つのノードを「主サイト」、ネットワーク上の他のノードを「従サイト」として、次の手順でコミットが行われます。


[第1相(投票層)]
主サイトはネットワーク上の全ての従サイトにコミットの可否を問い合わせる。
全ての従サイトは主サイトにコミットの可否を応答する。
[第2相(決定相)]
全ての従サイトからコミットの合意を得られた場合は、全ての従サイトにコミットの実行要求を発行する。コミットの停止を応答した従サイトがあった場合、またはタイムアウトとなった場合は、全ての従サイトにロールバックの実行要求を発行する。
全ての従サイトは、コミット(またはロールバック)の完了とともに主サイトに処理完了のメッセージを送る。
主サイトが、全ての従サイトからの処理完了メッセージを受け取り、トランザクションの完了となる。





- 一相コミットメントでは，あるトランザクション処理が発生して，複数のデータベースが更新されたときに片方がエラーを起こしてしまうと，更新処理に矛盾が起きてトランザクション処理の原則（ACID特性）である「原子性」と「一貫性」を満たさなくなってしまう。

![２相コミットメント](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/commit1.png)  

- ２相コミットメントでは「確定することもできるし」「元に戻すこともできる」状態であるセキュア状態を作り出すことで，片方に異常が起こった場合にロールバックを可能にする。

![２相コミットメント](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/commit2.png)  


![２相コミットメント](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/2Commit_01.png)  
![２相コミットメント](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/2Commit_02.png)  
![２相コミットメント](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/2Commit_03.png)  
![２相コミットメント](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/2Commit_04.png)  




## B+木インデックス

![B+木インデックス](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/B+tree_index_1.png)  
![B+木インデックス](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/B+tree_index_2.png)  
![B+木インデックス](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/B+tree_index_3.png)  
![B+木インデックス](https://github.com/MediumMountain/Study_Security/blob/main/PICTURE/DB/B+tree_index_4.png)  


